<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDCA Security Assessment Report Visualizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1e88e5;
            --success-color: #43a047;
            --warning-color: #fb8c00;
            --danger-color: #e53935;
            --dark-bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
        }

        body {
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,.15);
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid var(--primary-color);
            font-weight: 600;
        }

        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }

        .mitre-table td input {
            width: 100%;
            border: 1px solid #dee2e6;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .mitre-table td input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(30, 136, 229, 0.25);
        }

        .success-rate-high {
            color: var(--success-color);
            font-weight: bold;
        }

        .success-rate-medium {
            color: var(--warning-color);
            font-weight: bold;
        }

        .success-rate-low {
            color: var(--danger-color);
            font-weight: bold;
        }

        .visualization-container {
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .visualization-container img {
            max-width: 100%;
            height: auto;
        }

        .status-message {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1050;
            max-width: 350px;
        }

        .csv-mapping-modal .mapping-row {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }

        .file-upload-area.dragover {
            border-color: var(--primary-color);
            background-color: #e3f2fd;
        }

        .btn-action {
            margin: 0 5px;
        }

        .numeric-input {
            text-align: center;
        }

        .error-input {
            border-color: var(--danger-color) !important;
        }

        .tab-content {
            padding-top: 20px;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #121212;
                color: #e0e0e0;
            }
            
            .card {
                background-color: #1e1e1e;
                color: #e0e0e0;
            }
            
            .card-header {
                background-color: #2d2d2d;
                color: #e0e0e0;
            }
            
            .table {
                color: #e0e0e0;
            }
            
            .form-control, .form-select {
                background-color: #2d2d2d;
                color: #e0e0e0;
                border-color: #444;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-shield-alt me-2"></i>
                IDCA Security Assessment Report Visualizer
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-light me-2" onclick="importCSV()">
                    <i class="fas fa-file-import me-1"></i> Import CSV
                </button>
                <button class="btn btn-light me-2" onclick="exportCSV()">
                    <i class="fas fa-file-export me-1"></i> Export CSV
                </button>
                <button class="btn btn-success" onclick="saveData()">
                    <i class="fas fa-save me-1"></i> Save Data
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Tabs -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button">
                    <i class="fas fa-info-circle me-1"></i> General Information
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="mitre-tab" data-bs-toggle="tab" data-bs-target="#mitre" type="button">
                    <i class="fas fa-crosshairs me-1"></i> MITRE ATT&CK
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules" type="button">
                    <i class="fas fa-check-circle me-1"></i> Triggered Rules
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="undetected-tab" data-bs-toggle="tab" data-bs-target="#undetected" type="button">
                    <i class="fas fa-exclamation-triangle me-1"></i> Undetected Techniques
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button">
                    <i class="fas fa-lightbulb me-1"></i> Recommendations
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="visualizations-tab" data-bs-toggle="tab" data-bs-target="#visualizations" type="button">
                    <i class="fas fa-chart-bar me-1"></i> Visualizations
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- General Information Tab -->
            <div class="tab-pane fade show active" id="general" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-building me-1"></i> Company Information
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Company Name</label>
                                    <input type="text" class="form-control" id="company_name" placeholder="Enter company name">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Report Date</label>
                                    <input type="date" class="form-control" id="report_date">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tester Name</label>
                                    <input type="text" class="form-control" id="tester_name" placeholder="Enter tester name">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Manager Name</label>
                                    <input type="text" class="form-control" id="manager_name" placeholder="Enter manager name">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Manager Title</label>
                                    <input type="text" class="form-control" id="manager_title" placeholder="Enter manager title">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-line me-1"></i> Test Results Summary
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Total Rules</label>
                                    <input type="number" class="form-control numeric-input" id="total_rules" min="0" placeholder="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tested Rules</label>
                                    <input type="number" class="form-control numeric-input" id="tested_rules" min="0" placeholder="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Triggered Rules</label>
                                    <input type="number" class="form-control numeric-input" id="triggered_rules" min="0" placeholder="0">
                                </div>
                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="coverage-info">Coverage: 0% | Success Rate: 0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MITRE ATT&CK Tab -->
            <div class="tab-pane fade" id="mitre" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-crosshairs me-1"></i> MITRE ATT&CK Tactics</span>
                        <button class="btn btn-sm btn-primary" onclick="addMitreRow()">
                            <i class="fas fa-plus me-1"></i> Add Tactic
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover mitre-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40%">Tactic Name</th>
                                        <th style="width: 20%" class="text-center">Test Count</th>
                                        <th style="width: 20%" class="text-center">Triggered Count</th>
                                        <th style="width: 15%" class="text-center">Success Rate</th>
                                        <th style="width: 5%" class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="mitre-tbody">
                                    <!-- Rows will be added dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Triggered Rules Tab -->
            <div class="tab-pane fade" id="rules" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-check-circle me-1"></i> Triggered Rules</span>
                        <button class="btn btn-sm btn-primary" onclick="addRuleRow()">
                            <i class="fas fa-plus me-1"></i> Add Rule
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 20%">MITRE ID</th>
                                        <th style="width: 50%">Rule Name</th>
                                        <th style="width: 20%">Severity</th>
                                        <th style="width: 10%" class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="rules-tbody">
                                    <!-- Rows will be added dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Undetected Techniques Tab -->
            <div class="tab-pane fade" id="undetected" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-exclamation-triangle me-1"></i> Undetected Techniques</span>
                        <button class="btn btn-sm btn-primary" onclick="addUndetectedRow()">
                            <i class="fas fa-plus me-1"></i> Add Technique
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 15%">MITRE ID</th>
                                        <th style="width: 30%">Technique Name</th>
                                        <th style="width: 45%">Description</th>
                                        <th style="width: 10%" class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="undetected-tbody">
                                    <!-- Rows will be added dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations Tab -->
            <div class="tab-pane fade" id="recommendations" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-lightbulb me-1"></i> Recommendations</span>
                        <button class="btn btn-sm btn-primary" onclick="addRecommendationRow()">
                            <i class="fas fa-plus me-1"></i> Add Recommendation
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 20%">Priority</th>
                                        <th style="width: 70%">Description</th>
                                        <th style="width: 10%" class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recommendations-tbody">
                                    <!-- Rows will be added dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualizations Tab -->
            <div class="tab-pane fade" id="visualizations" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar me-1"></i> Report Visualizations
                            </div>
                            <div class="card-body">
                                <div class="btn-group mb-3" role="group">
                                    <button class="btn btn-outline-primary" onclick="loadVisualization('coverage')">
                                        <i class="fas fa-chart-pie me-1"></i> Test Coverage
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="loadVisualization('mitre_heatmap')">
                                        <i class="fas fa-th me-1"></i> MITRE Heatmap
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="loadVisualization('severity')">
                                        <i class="fas fa-chart-bar me-1"></i> Severity Distribution
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="loadVisualization('top_gaps')">
                                        <i class="fas fa-exclamation-circle me-1"></i> Top Gaps
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="loadVisualization('summary')">
                                        <i class="fas fa-tachometer-alt me-1"></i> Summary Dashboard
                                    </button>
                                </div>
                                <div id="visualization-container" class="visualization-container">
                                    <p class="text-muted">Select a visualization to display</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div class="modal fade" id="csvImportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import CSV File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="file-upload-area" id="csvUploadArea">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                        <p class="mb-2">Drag and drop your CSV file here</p>
                        <p class="text-muted mb-3">or</p>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">
                            Browse Files
                        </button>
                    </div>
                    <div id="csvMappingArea" style="display: none;">
                        <h6>Map CSV Columns to Fields</h6>
                        <div id="csvMappingContent"></div>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="processCsvImport()">Import Data</button>
                            <button class="btn btn-secondary" onclick="resetCsvImport()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Global variables
        let currentData = {};
        let csvImportData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Test results listeners
            document.getElementById('total_rules').addEventListener('input', updateCoverageInfo);
            document.getElementById('tested_rules').addEventListener('input', updateCoverageInfo);
            document.getElementById('triggered_rules').addEventListener('input', updateCoverageInfo);

            // CSV upload
            const csvUploadArea = document.getElementById('csvUploadArea');
            const csvFileInput = document.getElementById('csvFileInput');

            csvUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                csvUploadArea.classList.add('dragover');
            });

            csvUploadArea.addEventListener('dragleave', () => {
                csvUploadArea.classList.remove('dragover');
            });

            csvUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                csvUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleCsvFile(files[0]);
                }
            });

            csvFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleCsvFile(e.target.files[0]);
                }
            });
        }

        // Load data from server
        async function loadData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                currentData = data;
                populateForm(data);
                showStatus('Data loaded successfully', 'success');
            } catch (error) {
                showStatus('Error loading data: ' + error.message, 'danger');
            }
        }

        // Save data to server
        async function saveData() {
            try {
                const data = collectFormData();
                const response = await fetch('/api/data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    showStatus('Data saved successfully', 'success');
                } else {
                    showStatus('Error: ' + result.message, 'danger');
                }
            } catch (error) {
                showStatus('Error saving data: ' + error.message, 'danger');
            }
        }

        // Populate form with data
        function populateForm(data) {
            // General info
            if (data.general) {
                document.getElementById('company_name').value = data.general.company_name || '';
                document.getElementById('report_date').value = data.general.report_date || '';
                document.getElementById('tester_name').value = data.general.tester_name || '';
                document.getElementById('manager_name').value = data.general.manager_name || '';
                document.getElementById('manager_title').value = data.general.manager_title || '';
            }

            // Test results
            if (data.test_results) {
                document.getElementById('total_rules').value = data.test_results.total_rules || 0;
                document.getElementById('tested_rules').value = data.test_results.tested_rules || 0;
                document.getElementById('triggered_rules').value = data.test_results.triggered_rules || 0;
                updateCoverageInfo();
            }

            // MITRE tactics
            const mitreTbody = document.getElementById('mitre-tbody');
            mitreTbody.innerHTML = '';
            if (data.mitre_tactics) {
                Object.values(data.mitre_tactics).forEach(tactic => {
                    addMitreRow(tactic);
                });
            }

            // Triggered rules
            const rulesTbody = document.getElementById('rules-tbody');
            rulesTbody.innerHTML = '';
            if (data.triggered_rules) {
                data.triggered_rules.forEach(rule => {
                    addRuleRow(rule);
                });
            }

            // Undetected techniques
            const undetectedTbody = document.getElementById('undetected-tbody');
            undetectedTbody.innerHTML = '';
            if (data.undetected_techniques) {
                data.undetected_techniques.forEach(technique => {
                    addUndetectedRow(technique);
                });
            }

            // Recommendations
            const recommendationsTbody = document.getElementById('recommendations-tbody');
            recommendationsTbody.innerHTML = '';
            if (data.recommendations) {
                data.recommendations.forEach(rec => {
                    addRecommendationRow(rec);
                });
            }
        }

        // Collect form data
        function collectFormData() {
            const data = {
                general: {
                    company_name: document.getElementById('company_name').value,
                    report_date: document.getElementById('report_date').value,
                    tester_name: document.getElementById('tester_name').value,
                    manager_name: document.getElementById('manager_name').value,
                    manager_title: document.getElementById('manager_title').value
                },
                test_results: {
                    total_rules: parseInt(document.getElementById('total_rules').value) || 0,
                    tested_rules: parseInt(document.getElementById('tested_rules').value) || 0,
                    triggered_rules: parseInt(document.getElementById('triggered_rules').value) || 0
                },
                mitre_tactics: [],
                triggered_rules: [],
                undetected_techniques: [],
                recommendations: []
            };

            // Collect MITRE tactics
            const mitreRows = document.querySelectorAll('#mitre-tbody tr');
            mitreRows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value) {
                    data.mitre_tactics.push({
                        name: inputs[0].value,
                        test_count: parseInt(inputs[1].value) || 0,
                        triggered_count: parseInt(inputs[2].value) || 0
                    });
                }
            });

            // Collect triggered rules
            const ruleRows = document.querySelectorAll('#rules-tbody tr');
            ruleRows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const select = row.querySelector('select');
                if (inputs[0].value && inputs[1].value) {
                    data.triggered_rules.push({
                        mitre_id: inputs[0].value,
                        rule_name: inputs[1].value,
                        severity: select.value
                    });
                }
            });

            // Collect undetected techniques
            const undetectedRows = document.querySelectorAll('#undetected-tbody tr');
            undetectedRows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value) {
                    data.undetected_techniques.push({
                        mitre_id: inputs[0].value,
                        technique_name: inputs[1].value,
                        description: inputs[2].value
                    });
                }
            });

            // Collect recommendations
            const recRows = document.querySelectorAll('#recommendations-tbody tr');
            recRows.forEach(row => {
                const select = row.querySelector('select');
                const textarea = row.querySelector('textarea');
                if (textarea.value) {
                    data.recommendations.push({
                        priority: select.value,
                        description: textarea.value
                    });
                }
            });

            return data;
        }

        // MITRE table functions
        function addMitreRow(data = {}) {
            const tbody = document.getElementById('mitre-tbody');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td><input type="text" class="form-control" placeholder="Enter tactic name" value="${data.name || ''}"></td>
                <td><input type="number" class="form-control numeric-input" min="0" placeholder="0" value="${data.test_count || ''}" onchange="updateMitreSuccessRate(this)"></td>
                <td><input type="number" class="form-control numeric-input" min="0" placeholder="0" value="${data.triggered_count || ''}" onchange="updateMitreSuccessRate(this)"></td>
                <td class="text-center success-rate">0%</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-danger" onclick="removeRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
            if (data.test_count && data.triggered_count) {
                updateMitreSuccessRate(row.querySelector('input[type="number"]'));
            }
        }

        function updateMitreSuccessRate(input) {
            const row = input.closest('tr');
            const testCount = parseInt(row.cells[1].querySelector('input').value) || 0;
            const triggeredCount = parseInt(row.cells[2].querySelector('input').value) || 0;
            const successRateCell = row.cells[3];
            
            if (testCount === 0) {
                successRateCell.textContent = '0%';
                successRateCell.className = 'text-center success-rate';
            } else if (triggeredCount > testCount) {
                successRateCell.textContent = 'Error';
                successRateCell.className = 'text-center success-rate success-rate-low';
                row.cells[2].querySelector('input').classList.add('error-input');
            } else {
                row.cells[2].querySelector('input').classList.remove('error-input');
                const rate = (triggeredCount / testCount) * 100;
                successRateCell.textContent = `${rate.toFixed(1)}%`;
                
                // Apply color coding
                if (rate >= 70) {
                    successRateCell.className = 'text-center success-rate success-rate-high';
                } else if (rate >= 40) {
                    successRateCell.className = 'text-center success-rate success-rate-medium';
                } else {
                    successRateCell.className = 'text-center success-rate success-rate-low';
                }
            }
        }

        // Rule table functions
        function addRuleRow(data = {}) {
            const tbody = document.getElementById('rules-tbody');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td><input type="text" class="form-control" placeholder="T####" value="${data.mitre_id || ''}" onblur="validateMitreId(this)"></td>
                <td><input type="text" class="form-control" placeholder="Enter rule name" value="${data.rule_name || ''}"></td>
                <td>
                    <select class="form-select">
                        <option value="Low" ${data.severity === 'Low' ? 'selected' : ''}>Low</option>
                        <option value="Medium" ${data.severity === 'Medium' ? 'selected' : ''}>Medium</option>
                        <option value="High" ${data.severity === 'High' ? 'selected' : ''}>High</option>
                        <option value="Critical" ${data.severity === 'Critical' ? 'selected' : ''}>Critical</option>
                    </select>
                </td>
                <td class="text-center">
                    <button class="btn btn-sm btn-danger" onclick="removeRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        }

        // Undetected table functions
        function addUndetectedRow(data = {}) {
            const tbody = document.getElementById('undetected-tbody');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td><input type="text" class="form-control" placeholder="T####" value="${data.mitre_id || ''}" onblur="validateMitreId(this)"></td>
                <td><input type="text" class="form-control" placeholder="Enter technique name" value="${data.technique_name || ''}"></td>
                <td><input type="text" class="form-control" placeholder="Enter description" value="${data.description || ''}"></td>
                <td class="text-center">
                    <button class="btn btn-sm btn-danger" onclick="removeRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        }

        // Recommendations table functions
        function addRecommendationRow(data = {}) {
            const tbody = document.getElementById('recommendations-tbody');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>
                    <select class="form-select">
                        <option value="Critical" ${data.priority === 'Critical' ? 'selected' : ''}>Critical</option>
                        <option value="High" ${data.priority === 'High' ? 'selected' : ''}>High</option>
                        <option value="Medium" ${data.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                        <option value="Low" ${data.priority === 'Low' ? 'selected' : ''}>Low</option>
                    </select>
                </td>
                <td><textarea class="form-control" rows="2" placeholder="Enter recommendation">${data.description || ''}</textarea></td>
                <td class="text-center">
                    <button class="btn btn-sm btn-danger" onclick="removeRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        }

        // Generic remove row function
        function removeRow(button) {
            button.closest('tr').remove();
        }

        // Validation functions
        function validateMitreId(input) {
            const pattern = /^(T|TA)\d{4}(\.\d{3})?$/;
            if (!pattern.test(input.value) && input.value !== '') {
                input.classList.add('error-input');
                showStatus('Invalid MITRE ID format. Use T#### or TA####', 'warning');
            } else {
                input.classList.remove('error-input');
            }
        }

        // Update coverage info
        function updateCoverageInfo() {
            const total = parseInt(document.getElementById('total_rules').value) || 0;
            const tested = parseInt(document.getElementById('tested_rules').value) || 0;
            const triggered = parseInt(document.getElementById('triggered_rules').value) || 0;
            
            let coverage = 0;
            let successRate = 0;
            
            if (total > 0) {
                coverage = (tested / total * 100).toFixed(1);
            }
            
            if (tested > 0) {
                successRate = (triggered / tested * 100).toFixed(1);
            }
            
            document.getElementById('coverage-info').textContent = 
                `Coverage: ${coverage}% | Success Rate: ${successRate}%`;
        }

        // CSV Import functions
        function importCSV() {
            const modal = new bootstrap.Modal(document.getElementById('csvImportModal'));
            modal.show();
        }

        function handleCsvFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/import/csv', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    csvImportData = result.data;
                    showCsvMapping(result.data);
                } else {
                    showStatus('Error importing CSV: ' + result.message, 'danger');
                }
            })
            .catch(error => {
                showStatus('Error importing CSV: ' + error.message, 'danger');
            });
        }

        function showCsvMapping(data) {
            document.getElementById('csvUploadArea').style.display = 'none';
            document.getElementById('csvMappingArea').style.display = 'block';
            
            const mappingContent = document.getElementById('csvMappingContent');
            mappingContent.innerHTML = '';
            
            // Create mapping interface
            const mappingGroups = {
                'MITRE Tactics': ['tactic', 'test_count', 'triggered_count'],
                'Triggered Rules': ['mitre_id', 'rule_name', 'severity'],
                'Undetected Techniques': ['mitre_id', 'technique_name', 'description']
            };
            
            Object.entries(mappingGroups).forEach(([group, fields]) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'mb-3';
                groupDiv.innerHTML = `<h6>${group}</h6>`;
                
                fields.forEach(field => {
                    const mappingRow = document.createElement('div');
                    mappingRow.className = 'mapping-row';
                    
                    const suggested = data.suggested_mappings[field] || '';
                    
                    mappingRow.innerHTML = `
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label>${field.replace('_', ' ').toUpperCase()}</label>
                            </div>
                            <div class="col-md-8">
                                <select class="form-select" data-field="${field}">
                                    <option value="">-- Select CSV Column --</option>
                                    ${data.headers.map(header => 
                                        `<option value="${header}" ${header === suggested ? 'selected' : ''}>${header}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    `;
                    
                    groupDiv.appendChild(mappingRow);
                });
                
                mappingContent.appendChild(groupDiv);
            });
        }

        function processCsvImport() {
            // Collect mappings
            const mappings = {};
            document.querySelectorAll('#csvMappingContent select').forEach(select => {
                const field = select.getAttribute('data-field');
                const column = select.value;
                if (column) {
                    mappings[field] = column;
                }
            });
            
            // Process the imported data based on mappings
            // This is a simplified version - you'd want to add more validation
            if (mappings.tactic && mappings.test_count && mappings.triggered_count) {
                // Import MITRE tactics
                csvImportData.rows.forEach(row => {
                    if (row[mappings.tactic]) {
                        addMitreRow({
                            name: row[mappings.tactic],
                            test_count: row[mappings.test_count],
                            triggered_count: row[mappings.triggered_count]
                        });
                    }
                });
            }
            
            // Close modal and show success
            bootstrap.Modal.getInstance(document.getElementById('csvImportModal')).hide();
            showStatus('CSV data imported successfully', 'success');
            resetCsvImport();
        }

        function resetCsvImport() {
            document.getElementById('csvUploadArea').style.display = 'block';
            document.getElementById('csvMappingArea').style.display = 'none';
            document.getElementById('csvFileInput').value = '';
            csvImportData = null;
        }

        // Export CSV
        async function exportCSV() {
            try {
                const response = await fetch('/api/export/csv');
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'idca_export.zip';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                showStatus('Data exported successfully', 'success');
            } catch (error) {
                showStatus('Error exporting data: ' + error.message, 'danger');
            }
        }

        // Load visualization
        async function loadVisualization(type) {
            const container = document.getElementById('visualization-container');
            container.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
            
            try {
                const response = await fetch(`/api/visualizations/${type}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    container.innerHTML = `<img src="${result.image}" alt="${type} visualization">`;
                } else {
                    container.innerHTML = `<p class="text-danger">Error loading visualization: ${result.message}</p>`;
                }
            } catch (error) {
                container.innerHTML = `<p class="text-danger">Error loading visualization: ${error.message}</p>`;
            }
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show status-message`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>